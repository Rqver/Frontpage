<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Frontpage</title>
    <link href="/css/tailwind.css" rel="stylesheet">
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

        .column-transition { transition: all 0.3s ease; }

        .toggle-checkbox:checked { right: 0; border-color: #3B82F6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3B82F6; }

        #settings-list li { transition: transform 0.1s, opacity 0.2s, background-color 0.2s; }
        .sortable-ghost { opacity: 0.5; background: #2a2a2a; border-color: #4b5563; }
    </style>
</head>
<body class="bg-[#111111] text-gray-300 antialiased min-h-screen font-sans">

<main class="p-4 md:p-6">
    <div id="masonry-root" class="flex gap-6 items-start justify-center">
        <div class="text-gray-500 animate-pulse mt-10">Loading...</div>
    </div>
</main>

<button onclick="openSettings()" class="fixed bottom-6 right-6 p-3 bg-[#1a1a1a] border border-gray-800 rounded-full shadow-lg hover:bg-[#252525] hover:border-gray-600 transition-all text-gray-400 hover:text-white z-40">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
</button>

<div id="settings-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-[#161616] border border-gray-800 rounded-lg shadow-2xl w-full max-w-md flex flex-col max-h-[85vh]">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-[#1a1a1a] rounded-t-lg">
            <h3 class="text-base font-bold text-gray-100 uppercase tracking-wide">Customize Feed</h3>
            <button onclick="closeSettings()" class="text-gray-500 hover:text-white transition-colors cursor-pointer">&times;</button>
        </div>
        <div class="p-2 overflow-y-auto">
            <ul id="settings-list" class="space-y-1"></ul>
        </div>
        <div class="p-3 border-t border-gray-800 flex justify-end gap-2 bg-[#1a1a1a] rounded-b-lg">
            <button onclick="closeSettings()" class="text-sm px-3 py-1.5 text-gray-400 hover:text-white transition-colors">Cancel</button>
            <button onclick="saveSettings()" class="text-sm px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded font-medium transition-colors">Save</button>
        </div>
    </div>
</div>

<script>
    let allSitesData = [];

    const INITIAL_STORY_COUNT = 10;

    async function refreshData() {
        try {
            const response = await fetch('/api/get-sites');
            if (!response.ok) throw new Error('Failed to load');
            allSitesData = await response.json();

            renderMasonry();
        } catch (error) {
            console.error(error);
            document.getElementById('masonry-root').innerHTML = `<div class="text-red-500">Error loading feeds.</div>`;
        }

        setTimeout(refreshData, 30_000)
    }

    function renderMasonry() {
        const root = document.getElementById('masonry-root');
        const width = window.innerWidth;

        let colCount = 1;
        if (width >= 768) colCount = 2;  // md
        if (width >= 1024) colCount = 3; // lg
        if (width >= 1280) colCount = 4; // xl

        const columns = Array.from({ length: colCount }, () => []);

        getProcessedData().forEach((site, index) => {
            columns[index % colCount].push(site);
        });

        root.innerHTML = '';

        columns.forEach(colSites => {
            const colDiv = document.createElement('div');
            colDiv.className = 'flex flex-col gap-6 flex-1 min-w-0';

            colSites.forEach(site => {
                const card = buildCard(site);
                colDiv.appendChild(card);
            });

            root.appendChild(colDiv);
        });
    }

    function buildCard(site) {
        const card = document.createElement('div');
        card.className = 'bg-[#161616] rounded-md border border-gray-800 flex flex-col shadow-lg overflow-hidden';

        const header = document.createElement('div');
        header.className = 'p-3 border-b border-gray-800 flex items-center gap-3 bg-[#1a1a1a]';
        header.innerHTML = `
                <img src="${site.image}" alt="${site.name}" class="w-5 h-5 object-contain rounded-sm opacity-90">
                <h2 class="font-bold text-gray-100 text-sm uppercase tracking-wide">${site.name}</h2>
            `;

        const list = document.createElement('ul');
        list.className = 'divide-y divide-gray-800/50';

        const hasMore = site.stories.length > INITIAL_STORY_COUNT;

        site.stories.forEach((story, index) => {
            const li = document.createElement('li');
            const isHidden = index >= INITIAL_STORY_COUNT;

            li.className = `p-3 hover:bg-[#1f1f1f] transition-colors group ${isHidden ? 'hidden extra-story' : ''}`;

            const breakingHtml = story.isBreaking
                ? `<div class="shrink-0 pt-1.5 mr-2.5">
                         <span class="flex relative h-2.5 w-2.5">
                           <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                           <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-red-600"></span>
                         </span>
                       </div>`
                : '';

            const titleColor = story.isBreaking ? 'text-white font-semibold' : 'text-gray-100 group-hover:text-blue-400';

            li.innerHTML = `
                    <a href="${story.link}" target="_blank" class="flex items-start text-sm leading-snug">
                        ${breakingHtml}
                        <span class="${titleColor} transition-colors">${story.title}</span>
                    </a>
                `;
            list.appendChild(li);
        });

        const footer = document.createElement('div');
        if (hasMore) {
            footer.className = 'p-2 border-t border-gray-800 bg-[#181818]';
            const btn = document.createElement('button');
            btn.className = 'text-xs font-bold text-gray-500 hover:text-white uppercase tracking-widest w-full py-1.5 transition-colors';
            btn.innerText = 'Show More';

            let expanded = false;

            btn.onclick = () => {
                const hiddenItems = list.querySelectorAll('.extra-story');
                expanded = !expanded;

                if (expanded) {
                    hiddenItems.forEach(el => el.classList.remove('hidden'));
                    btn.innerText = 'Show Less';
                } else {
                    hiddenItems.forEach(el => el.classList.add('hidden'));
                    btn.innerText = 'Show More';
                    card.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            };
            footer.appendChild(btn);
        }

        card.appendChild(header);
        card.appendChild(list);
        if (hasMore) card.appendChild(footer);

        return card;
    }

    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            renderMasonry();
        }, 200);
    });

    refreshData();

    function getProcessedData() {
        const saved = JSON.parse(localStorage.getItem('order') || '[]');
        if (!saved.length) return allSitesData;

        const prefsMap = new Map(saved.map(p => [p.id, p]));
        return allSitesData
            .filter(site => {
                const p = prefsMap.get(site.id);
                return p ? p.visible : true;
            })
            .sort((a, b) => {
                const indexA = saved.findIndex(p => p.id === a.id);
                const indexB = saved.findIndex(p => p.id === b.id);
                return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
            });
    }

    function openSettings() {
        const list = document.getElementById('settings-list');
        list.innerHTML = '';

        const saved = JSON.parse(localStorage.getItem('order') || '[]');
        const existingIds = new Set(saved.map(p => p.id));
        const allSorted = [...saved];

        allSitesData.forEach(site => {
            if (!existingIds.has(site.id)) allSorted.push({ id: site.id, visible: true });
        });

        const dataMap = new Map(allSitesData.map(s => [s.id, s]));

        allSorted.forEach(pref => {
            const site = dataMap.get(pref.id);
            if (!site) return;

            const li = document.createElement('li');
            li.draggable = true;
            li.dataset.id = site.id;
            li.className = 'flex items-center gap-3 p-3 bg-[#1e1e1e] border border-gray-800 rounded cursor-grab active:cursor-grabbing hover:bg-[#252525] select-none';

            li.innerHTML = `
                <div class="text-gray-600">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 8h16M4 16h16"></path></svg>
                </div>
                <img src="${site.image}" class="w-5 h-5 rounded-sm opacity-80 pointer-events-none" />
                <span class="flex-1 font-medium text-sm text-gray-200 pointer-events-none">${site.name}</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer" ${pref.visible ? 'checked' : ''}>
                    <div class="w-9 h-5 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            `;

            li.addEventListener('dragstart', handleDragStart);
            li.addEventListener('dragover', handleDragOver);
            li.addEventListener('drop', handleDrop);
            li.addEventListener('dragend', handleDragEnd);
            list.appendChild(li);
        });

        document.getElementById('settings-modal').classList.remove('hidden');
    }

    function closeSettings() {
        document.getElementById('settings-modal').classList.add('hidden');
    }

    function saveSettings() {
        const items = document.querySelectorAll('#settings-list li');
        const order = Array.from(items).map(li => ({
            id: li.dataset.id,
            visible: li.querySelector('input[type="checkbox"]').checked
        }));

        localStorage.setItem('order', JSON.stringify(order));
        closeSettings();
        renderMasonry();
    }

    let draggedItem = null;

    function handleDragStart(e) {
        draggedItem = this;
        e.dataTransfer.effectAllowed = 'move';
        this.classList.add('sortable-ghost');
    }

    function handleDragOver(e) {
        e.preventDefault();

        const target = e.currentTarget;
        if (target === draggedItem || target.nodeName !== 'LI') return;

        const list = target.parentNode;
        const bounding = target.getBoundingClientRect();
        const offset = bounding.y + (bounding.height / 2);

        if (e.clientY - offset > 0) {
            if (target.nextSibling !== draggedItem) {
                list.insertBefore(draggedItem, target.nextSibling);
            }
        } else {
            if (target.previousSibling !== draggedItem) {
                list.insertBefore(draggedItem, target);
            }
        }
    }

    function handleDrop(e) {
        e.stopPropagation();
        e.preventDefault();
    }

    function handleDragEnd(e) {
        this.classList.remove('sortable-ghost');
        draggedItem = null;
    }
</script>
</body>
</html>
